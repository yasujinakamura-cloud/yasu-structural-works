<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STRUCTURE — YASU</title>

  <!-- PCと同じテーマ（見た目のDNAは共通） -->
  <link rel="stylesheet" href="../../assets/theme.css?v=20260222b" />
  <!-- スマホ専用（PCに一切影響しない） -->
  <link rel="stylesheet" href="../../assets/mobile.css?v=20260222b" />
</head>

<body class="mobile-series" data-series="structure">
  <header class="m-head">
    <a class="m-back" href="../../index.html">← HOME</a>
    <button class="m-info" type="button" aria-pressed="true">INFO</button>
  </header>

  <h1 class="m-title">STRUCTURE</h1>

  <!-- スクロールコンテナ -->
  <main id="mFeed" class="m-feed" aria-live="polite"></main>

  <!-- 上下ナビ（1枚ずつ強制ジャンプ） -->
  <nav class="m-nav" aria-label="Photo navigation">
    <button class="m-navBtn" type="button" data-nav="up" aria-label="Previous photo">↑</button>
    <button class="m-navBtn" type="button" data-nav="down" aria-label="Next photo">↓</button>
  </nav>

  <script>
  (async function(){
    const FEED   = document.getElementById('mFeed');
    const infoBtn= document.querySelector('.m-info');
    const head   = document.querySelector('.m-head');
    const title  = document.querySelector('.m-title');

    // ===== BASE（最重要）：GitHub Pages / ローカルで自動切替 =====
    // 本番: https://yasujinakamura-cloud.github.io/yasu-structural-works/...
    //   -> BASE = "/yasu-structural-works/"
    // ローカル(Live Serverなど): http://127.0.0.1:5500/...
    //   -> BASE = "/"
    const BASE = location.hostname.includes('github.io')
      ? '/yasu-structural-works/'
      : '/';

    // series は body data-series から取得（コピペ事故防止）
    const series = document.body.dataset.series || 'structure';

    // 絶対パスで固定（どこにHTMLを置いても壊れない）
    const JSON_URL = `${BASE}series/${series}/${series}.json`;
    const IMG_DIR  = `${BASE}series/${series}/images/`;

    // ===== ヘッダー高さをCSS変数へ（ズレ対策） =====
    function setHeadVars(){
      const h  = head  ? head.getBoundingClientRect().height : 0;
      const th = title ? title.getBoundingClientRect().height : 0;
      document.documentElement.style.setProperty('--mhead-h',  h + 'px');
      document.documentElement.style.setProperty('--mtitle-h', th + 'px');
    }
    setHeadVars();
    window.addEventListener('resize', setHeadVars, { passive:true });
    window.addEventListener('orientationchange', setHeadVars, { passive:true });

    // ===== INFO 初期：ON =====
    let showInfo = true;
    applyInfoState();

    infoBtn.addEventListener('click', () => {
      showInfo = !showInfo;
      applyInfoState();
    });

    function applyInfoState(){
      document.documentElement.classList.toggle('show-info', showInfo);
      infoBtn.setAttribute('aria-pressed', String(showInfo));
    }

    // ===== UI: ↑↓（先頭/末尾で止める） =====
    const btnUp   = document.querySelector('[data-nav="up"]');
    const btnDown = document.querySelector('[data-nav="down"]');

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // 1枚=1画面 前提（m-post の height で合わせる）
    function getCurrentIndex(total){
      const h = FEED.clientHeight || 1;
      return clamp(Math.round(FEED.scrollTop / h), 0, total - 1);
    }

    function setBtnState(i,total){
      const upDisabled   = (i <= 0);
      const downDisabled = (i >= total - 1);

      btnUp.disabled = upDisabled;
      btnDown.disabled = downDisabled;

      btnUp.style.opacity = upDisabled ? '0.35' : '1';
      btnDown.style.opacity = downDisabled ? '0.35' : '1';
    }

    function goToIndex(i,total){
      const h = FEED.clientHeight || 1;
      const next = clamp(i, 0, total - 1);
      const cur  = getCurrentIndex(total);
      if(next === cur) return; // 先頭/末尾で止める（黒画面/空白防止の核）
      FEED.scrollTo({ top: next * h, behavior: 'smooth' });
      setBtnState(next,total);
    }

    // ===== JSONロードして描画 =====
    try{
      const res = await fetch(JSON_URL, { cache:'no-store' });
      if(!res.ok){
        throw new Error(`JSON load failed: ${res.status} ${res.statusText} | ${JSON_URL}`);
      }
      const data = await res.json();

      const images = Array.isArray(data.images) ? data.images : [];
      if(!images.length){
        throw new Error(`No images in JSON | ${JSON_URL}`);
      }

      // ここだけ：FEED.innerHTML は1回だけ
      FEED.innerHTML = images.map((it, idx) => {
        const n = String(idx+1).padStart(2,'0');
        const stmt = escapeHtml(it.statement || '');
        const cam  = escapeHtml(it.camera || '');
        const lens = escapeHtml(it.lens || '');
        const camLine  = cam  ? `<div class="m-gear__line m-gear__cam">${cam}</div>` : '';
        const lensLine = lens ? `<div class="m-gear__line m-gear__lens">${lens}</div>` : '';



        return `
          <article class="m-post" data-index="${idx}">
            <div class="m-meta">
              <div class="m-statement">${stmt}</div>
              <div class="m-gear" data-gear>
                ${camLine}
                ${lensLine}
              </div>
            </div>

            <figure class="m-frame">
              <img class="m-photo"
                   src="${IMG_DIR + escapeHtml(it.file)}"
                   alt="${escapeHtml((data.title || series).toUpperCase())} ${n}"
                   loading="lazy"
                   decoding="async">
            </figure>

            <div class="m-count">${n} / ${String(images.length).padStart(2,'0')}</div>
          </article>
        `;
      }).join('');

      // 描画後に再計算（iOSズレ対策）
      setHeadVars();

      const total = images.length;

      // 初期ボタン状態
      setBtnState(0,total);

      btnUp.addEventListener('click', () => {
        goToIndex(getCurrentIndex(total) - 1, total);
      });

      btnDown.addEventListener('click', () => {
        goToIndex(getCurrentIndex(total) + 1, total);
      });

      // スクロールに追随してボタン更新（軽くrAF）
      let ticking = false;
      FEED.addEventListener('scroll', () => {
        if(ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          setBtnState(getCurrentIndex(total), total);
          ticking = false;
        });
      }, { passive:true });

    }catch(e){
      console.error(e);
      FEED.innerHTML = `
        <p style="padding:18px;opacity:.85;letter-spacing:.08em;line-height:1.5">
          Series data not found.<br>
          <span style="opacity:.7;font-size:12px;display:block;margin-top:10px">
            ${escapeHtml(String(e.message || e))}
          </span>
        </p>
      `;
      // ボタンは無効化
      btnUp.disabled = true; btnDown.disabled = true;
      btnUp.style.opacity = '0.35'; btnDown.style.opacity = '0.35';
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
  })();
  </script>
</body>
</html>