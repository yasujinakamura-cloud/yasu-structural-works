<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STRUCTURE — YASU</title>

  <!-- PCと同じテーマ（見た目のDNAは共通） -->
  <link rel="stylesheet" href="../../assets/theme.css?v=20260222a" />
  <!-- スマホ専用（PCに一切影響しない） -->
  <link rel="stylesheet" href="../../assets/mobile.css?v=20260222a" />
</head>

<body class="mobile-series">
  <header class="m-head">
    <a class="m-back" href="../../index.html">← HOME</a>
    <button class="m-info" type="button" aria-pressed="false">INFO</button>
  </header>

  <h1 class="m-title">STRUCTURE</h1>

  <!-- ★スクロールコンテナ（ラッパー） -->
  <main id="mFeed" class="m-feed" aria-live="polite"></main>

  <!-- ★上下ナビ（1枚ずつ強制ジャンプ） -->
  <nav class="m-nav" aria-label="Photo navigation">
    <button class="m-navBtn" type="button" data-step="-1" aria-label="Previous photo">↑</button>
    <button class="m-navBtn" type="button" data-step="1" aria-label="Next photo">↓</button>
  </nav>

  <script>
  (async function(){
    const FEED = document.getElementById('mFeed');
    const infoBtn = document.querySelector('.m-info');
    const head = document.querySelector('.m-head');
    const title = document.querySelector('.m-title');
    const navBtns = document.querySelectorAll('.m-navBtn');

    // ★ヘッダー高さをCSS変数へ（スナップ位置ズレ対策）
    function setHeadHeightVar(){
      const h = head ? head.getBoundingClientRect().height : 0;
      document.documentElement.style.setProperty('--mhead-h', h + 'px');

      // タイトルがある場合、その高さも加味して「1枚=1画面」を計算
      const th = title ? title.getBoundingClientRect().height : 0;
      document.documentElement.style.setProperty('--mtitle-h', th + 'px');
    }
    setHeadHeightVar();
    window.addEventListener('resize', setHeadHeightVar, { passive: true });
    window.addEventListener('orientationchange', setHeadHeightVar, { passive: true });

    const series = 'structure';
    const JSON_URL = `./${series}.json`;

    // INFO 初期：ON
    let showInfo = true;
    applyInfoState();

    infoBtn.addEventListener('click', () => {
      showInfo = !showInfo;
      applyInfoState();
    });

    function applyInfoState(){
      document.documentElement.classList.toggle('show-info', showInfo);
      infoBtn.setAttribute('aria-pressed', String(showInfo));
    }

    try{
      const res = await fetch(JSON_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('Failed to load JSON');
      const data = await res.json();

      const images = Array.isArray(data.images) ? data.images : [];
      if(!images.length) throw new Error('No images');

      const IMG_DIR = 'images/';

      // ★ここが正しい：FEED.innerHTML はこの1回だけ
      FEED.innerHTML = images.map((it, idx) => {
        const n = String(idx+1).padStart(2,'0');
        const stmt = escapeHtml(it.statement || '');
        const cam  = escapeHtml(it.camera || '');
        const lens = escapeHtml(it.lens || '');
        const gear = [cam, lens].filter(Boolean).join(' / ');

        return `
          <article class="m-post m-item" data-index="${idx}">
            <div class="m-meta">
              <div class="m-statement">${stmt}</div>
              <div class="m-gear" data-gear>${escapeHtml(gear)}</div>
            </div>

            <figure class="m-frame">
              <img class="m-photo"
                   src="${IMG_DIR + escapeHtml(it.file)}"
                   alt="STRUCTURE ${n}"
                   loading="lazy"
                   decoding="async">
            </figure>

            <div class="m-count">${n} / ${String(images.length).padStart(2,'0')}</div>
          </article>
        `;
      }).join('');

      // DOMが積まれたあとに再計算（微妙なズレ対策）
      setHeadHeightVar();

      // ★上下矢印：次/前のスナップへ（1画面分スクロール）
      navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const step = Number(btn.dataset.step || 0);
          FEED.scrollBy({
            top: step * FEED.clientHeight,
            left: 0,
            behavior: 'smooth'
          });
        }, { passive: true });
      });

      // ★スワイプで止まりを強める（対応ブラウザのみ効く）
      // スナップが弱い端末向けの保険：スクロール終了っぽいタイミングで近い投稿へ寄せる
      let snapTimer = 0;
      FEED.addEventListener('scroll', () => {
        window.clearTimeout(snapTimer);
        snapTimer = window.setTimeout(() => {
          const items = Array.from(FEED.querySelectorAll('.m-item'));
          if (!items.length) return;

          const y = FEED.scrollTop;
          let best = items[0];
          let bestDist = Infinity;

          for (const it of items) {
            const top = it.offsetTop;
            const d = Math.abs(top - y);
            if (d < bestDist) { bestDist = d; best = it; }
          }
          // 近い開始位置へ吸着
          FEED.scrollTo({ top: best.offsetTop, behavior: 'smooth' });
        }, 90);
      }, { passive: true });

    }catch(e){
      console.error(e);
      FEED.innerHTML = `<p style="padding:18px;opacity:.8">Series data not found.</p>`;
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
  })();
  </script>
</body>
</html>